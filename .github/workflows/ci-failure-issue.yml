name: CI Failure Issue

on:
  workflow_run:
    workflows: ['CI']
    types: [completed]

permissions:
  contents: read
  issues: write

jobs:
  report-failure:
    if: github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main' && github.event.workflow_run.conclusion == 'failure'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update CI failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const title = `[CI] Failure: ${run.name} @ ${run.head_sha.slice(0, 7)}`;
            const body = [
              'CI failed.',
              '',
              `- Workflow: ${run.name}`,
              `- Run: ${run.html_url}`,
              `- Commit: ${run.head_sha}`,
              `- Branch: ${run.head_branch}`,
              `- Event: ${run.event}`,
              '',
              'Next steps:',
              '- npm run format',
              '- git commit && git push',
              '- Rerun CI'
            ].join('\n');

            const search = await github.rest.search.issuesAndPullRequests({
              q: `${title} repo:${context.repo.owner}/${context.repo.repo} is:open in:title`
            });

            if (search.data.items.length) {
              const issue = search.data.items[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `Still failing: ${run.html_url}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['ci-failure']
              });
            }

  close-success:
    if: github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main' && github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Close matching CI failure issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const run = context.payload.workflow_run;
            const title = `[CI] Failure: ${run.name} @ ${run.head_sha.slice(0, 7)}`;

            try {
              const search = await github.rest.search.issuesAndPullRequests({
                q: `${title} repo:${context.repo.owner}/${context.repo.repo} is:open in:title`
              });

              if (search.data.items.length) {
                const issue = search.data.items[0];
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `CI passed: ${run.html_url}\nClosing.`
                });
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
                console.log(`Closed issue #${issue.number}`);
              } else {
                console.log('No matching CI failure issue found to close - this is expected if CI did not fail previously');
              }
            } catch (error) {
              console.log(`Error searching for or closing CI failure issue: ${error.message}`);
              // Don't fail the workflow if we can't find/close an issue
            }
